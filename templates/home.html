{% extends "base.html" %}
{% block content %}
<div class="text-center mt-[5vh]">
<h1 class="text-4xl font-bold mb-4">Upload Image</h1>
<p class="text-[#828282]">Upload a minimum of 5 clear microscopic image of the blood smear.</p>

<div class="mt-[15vh] mb-4 max-w-screen-lg mx-auto flex gap-[10vw] justify-center">

    <!-- Upload from device -->
 <label for="fileUpload" class=" cursor-pointer px-8 py-3 rounded-xl border-[2px] border-[#555]"> Browse Files </label>
 <input class ="hidden" type="file" id="fileUpload" name="fileUpload" accept="image/*" multiple>

<!-- Navigate to camera -->
<a href="/camera"><button type="button" class=" px-8 py-3 rounded-xl border-[2px] border-[#555]">Take Photo</button></a>
</div>
<!-- Gallery preview -->
<div id="gallery" class="flex flex-wrap gap-2 mb-10 justify-center"></div>

<!-- Submit form -->
<form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" onsubmit="return prepareSubmit()">
    <div id="hiddenFilesContainer"></div>
    <button type="submit" class="px-8 py-2 rounded-xl text-white bg-[#21884C]">Start Analysis</button>
</form>

<script>
    const fileUpload = document.getElementById('fileUpload');
    const gallery = document.getElementById('gallery');
    const hiddenFilesContainer = document.getElementById('hiddenFilesContainer');
    let uploadedFiles = {{ uploaded_files | tojson | safe }};

    // Clear gallery first
    gallery.innerHTML = '';
    
    // Populate the gallery with existing uploaded files
    uploadedFiles.forEach(file => {
        const img = document.createElement('img');
        img.src = file;
        img.width = 100;
        gallery.appendChild(img);
    });

    fileUpload.addEventListener('change', (event) => {
        for (let file of event.target.files) {
            uploadedFiles.push(file);
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.width = 100;
            img.height = 100;
            gallery.appendChild(img);
        }
    });

    function prepareSubmit() {
        if (uploadedFiles.length < 5) {
            console.log('Not enough images uploaded:', uploadedFiles.length);
            alert('Please upload or capture at least 5 images.');
            return false;
        } else{
            alert(`You have uploaded ${uploadedFiles.length} images.`);
        };

        hiddenFilesContainer.innerHTML = '';
        for (let file of uploadedFiles) {
            if (typeof file === 'string') {
                // Add existing server-side files as hidden inputs
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'existing_files';
                input.value = file;
                hiddenFilesContainer.appendChild(input);
            } else {
                // Add newly uploaded files as file inputs
                const input = document.createElement('input');
                input.type = 'file';
                input.name = 'images';
                input.files = createFileList([file]);
                hiddenFilesContainer.appendChild(input);
            }
        }
        return true;
    }

    function createFileList(files) {
        const dataTransfer = new DataTransfer();
        for (const file of files) {
            dataTransfer.items.add(file);
        }
        return dataTransfer.files;
    }
</script>
</div>
{% endblock %}