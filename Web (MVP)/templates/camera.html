{% extends "base.html" %}
{% block content %}
<h2>Take Photo</h2>

<!-- Camera view -->
<video id="video" width="320" height="240" autoplay></video>

<!-- Captured preview -->
<canvas id="canvas" width="320" height="240" style="display: none;"></canvas>

<!-- Controls -->
<div id="captureControls">
    <button onclick="capturePhoto()">Capture</button>
</div>

<div id="previewControls" style="display: none;">
    <button onclick="savePhoto()">Done</button>
    <button onclick="retryPhoto()">Retry</button>
</div>

<script>
    let stream;

    window.onload = () => {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => {
                stream = s;
                document.getElementById('video').srcObject = s;
            })
            .catch(err => {
                alert("Camera access denied.");
                window.location.href = "/upload";
            });
    };

    function capturePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Hide video, show canvas preview and "Done/Retry"
        video.style.display = 'none';
        canvas.style.display = 'block';
        document.getElementById('captureControls').style.display = 'none';
        document.getElementById('previewControls').style.display = 'block';
    }

    function retryPhoto() {
        document.getElementById('canvas').style.display = 'none';
        document.getElementById('video').style.display = 'block';
        document.getElementById('captureControls').style.display = 'block';
        document.getElementById('previewControls').style.display = 'none';
    }

    function savePhoto() {
        const canvas = document.getElementById('canvas');
        canvas.toBlob(blob => {
            const file = new File([blob], `camera_${Date.now()}.png`, { type: 'image/png' });

            const formData = new FormData();
            formData.append('image', file);

            fetch('/save-temp-image', {
                method: 'POST',
                body: formData
            }).then(() => {
                window.location.href = '/upload';
            });
        }, 'image/png');
    }
</script>
{% endblock %}
